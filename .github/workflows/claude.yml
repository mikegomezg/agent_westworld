name: Claude Code

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]
    workflow_dispatch:

# Write perms so Claude can comment and push a branch/PR
permissions:
    id-token: write
    contents: write
    pull-requests: write
    issues: write

concurrency:
    group: claude-${{ github.event_name }}-${{ github.run_id }}
    cancel-in-progress: false

jobs:
    claude:
        # Only run when @claude is explicitly mentioned
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
            (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # full history helps with branching/pushing
                  persist-credentials: false # let the action manage its token
                  # ref: main                  # uncomment if your default branch isn't checked out

            - name: Run Claude Code
              uses: anthropics/claude-code-action@v1
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  # Keep this minimal at first. Add tools only if those scripts exist in your repo.
                  # claude_args: |
                  #   --allowedTools "Bash(bun install)"
                  #   --max-turns 5
                  #   --temperature 0.2
                  # Avoid hard-pinning a future-dated model until you know you need it.
                  # --model "<stable-model-here>"
