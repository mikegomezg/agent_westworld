---
import Layout from "../../layouts/Layout.astro";
import { loadAllScenes, loadAllCharacters, loadWorld } from "../../utils/yaml-loader.js";
import { generateSceneNarrative } from "../../utils/narrative-generator.js";

export function getStaticPaths() {
    const scenes = loadAllScenes();
    return scenes.map((scene) => ({
        params: { id: scene.id },
        props: { scene },
    }));
}

const { scene } = Astro.props;
const characters = loadAllCharacters();
const world = loadWorld();
const narrative = generateSceneNarrative(scene, characters, world);
---

<Layout title={scene.title}>
    <h1>{scene.title}</h1>
    <p class="meta">Episode {scene.episode} | {scene.location}</p>

    <section>
        <h2>Synopsis</h2>
        <p>{scene.synopsis}</p>
    </section>

    <section>
        <h2>Characters</h2>
        <ul>
            {
                scene.characters.map((charId) => {
                    const char = characters.find((c) => c.id === charId);
                    return (
                        <li>
                            <a href={`/characters/${charId}`}>{char?.name || charId}</a>
                        </li>
                    );
                })
            }
        </ul>
    </section>

    <section>
        <h2>Generated Narrative</h2>
        <div class="narrative" set:html={narrative} />
    </section>

    <section>
        <h2>Themes</h2>
        <ul>
            {scene.themes?.map((theme) => <li>{theme}</li>)}
        </ul>
    </section>

    <style>
        .meta {
            color: #666;
            font-style: italic;
        }
        .narrative {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
    </style>
</Layout>
